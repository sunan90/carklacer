<!DOCTYPE html>
<html>
<head>
  <title>Rekap Checklist Pegawai</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="logo.png" type="logo.png">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>Rekap Checklist Pegawai</h1>

  <div id="rekapContainer"></div>

  <button onclick="window.location.href='dashboard.html'">Kembali ke Dashboard</button>
  <button onclick="printRekap()">Print</button>
  <button onclick="downloadImage()">Download Gambar</button>

  <script>
    async function tampilkanSemuaRekap() {
      const rekapDiv = document.getElementById("rekapContainer");
      rekapDiv.innerHTML = `
        <table border="1" cellpadding="10" cellspacing="0">
          <thead>
            <tr>
              <th>Nama Pegawai</th>
              <th>Minggu 1</th>
              <th>Minggu 2</th>
              <th>Minggu 3</th>
              <th>Minggu 4</th>
              <th>Total Bulan</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="rekapTable"></tbody>
        </table>
      `;

      const tbody = document.getElementById("rekapTable");

      try {
        const response = await fetch('http://localhost:3000/api/checklist/rekap', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });
        if (!response.ok) {
          throw new Error('Failed to fetch recap data');
        }
        const recapData = await response.json();

        recapData.forEach(p => {
          const minggu = p.minggu.map(percent => percent + '%');
          const rataBulanan = p.totalPercent + '%';

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.nama}</td>
            <td>${minggu[0]}</td>
            <td>${minggu[1]}</td>
            <td>${minggu[2]}</td>
            <td>${minggu[3]}</td>
            <td><strong>${rataBulanan}</strong></td>
            <td><button onclick="shareWA('${p.nama}')">Share WA</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        rekapDiv.innerHTML = '<p>Error loading recap data. Please try again later.</p>';
        console.error(error);
      }
    }

    // Fungsi print
    function printRekap() {
      window.print();
    }

    // Fungsi download gambar rekap
    function downloadImage() {
      html2canvas(document.getElementById("rekapContainer")).then(canvas => {
        const link = document.createElement("a");
        link.download = "rekap-checklist.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    // Share ke WhatsApp per user
    function shareWA(nama) {
      let pesan = `Rekap Checklist ${nama}:\n\n`;
      let totalBulanan = 0;

      for (let minggu = 1; minggu <= 4; minggu++) {
        // Fetch recap data again for sharing
        // This can be optimized by caching recapData globally if needed
        // For simplicity, we fetch again here
        // Alternatively, pass recapData to shareWA function
      }

      // Since we don't have detailed weekly data here, just open WhatsApp with a generic message
      pesan += `Silakan cek detail rekap di aplikasi.`;

      // Ganti nomor admin di sini (pakai 62)
      const nomorAdmin = "6281216717977";

      const url = `https://wa.me/${nomorAdmin}?text=${encodeURIComponent(pesan)}`;
      window.open(url, '_blank');
    }

    tampilkanSemuaRekap();
  </script>
</body>
</html>
